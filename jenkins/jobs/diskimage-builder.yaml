- job-template:
    name: 'gate-dib-dsvm-functests-{node}'
    node: '{node}'

    builders:
      - shell: |
          #!/bin/bash -eux
          cd ~

          # Work around a bug where we get a disconnected HEAD ref if we dont clone with git first
          git clone file:///opt/git/openstack/diskimage-builder openstack/diskimage-builder
          git clone file:///opt/git/openstack/dib-utils openstack/dib-utils

          /usr/zuul-env/bin/zuul-cloner --cache-dir /opt/git \
            git://git.openstack.org \
            openstack/diskimage-builder \
            openstack/dib-utils

          export PATH=$PATH:$(pwd)/openstack/dib-utils/bin
          export PATH=$PATH:$(pwd)/openstack/diskimage-builder/bin

          ./openstack/diskimage-builder/tests/install_test_deps.sh
          ./openstack/diskimage-builder/tests/run_functests.sh

    publishers:
      - console-log
